var A=require("basic-auth"),m=require("mime-types"),u=require("multer")(),a=require("express")(),{QuickDB:f}=require("quick.db"),{MongoDriver:g}=require("quickmongo"),h=new g(process.env.m);a.use((_,b,c)=>{var d=["/","/remove"];if(d.includes(_.path)){var B=A(_);!B||B.name!==process.env.n||B.pass!==process.env.p?b.status(401).set("WWW-Authenticate",'Basic realm="Authorization Required"').send("Unauthorized"):c()}else c()});(async ()=>{await h.connect().then(()=>console.log(`Connected to the database!`));var _=new f({driver:h});a.get("/",async function(q,r){var c=[],d=await _.all();for(const b of d)c.push(`<li><a href="/${b.id}" target="_blank">${b.value.fn}</a></li>`);r.send(`<!DOCTYPE html><html><head><script>function validateForm(){var fileInput=document.getElementById('file');var file=fileInput.files[0];if(!file){alert('Please select a file');return false;}}</script></head><body><form action="/upload" method="post" enctype="multipart/form-data" onsubmit="return validateForm()"><input type="file" name="file" id="file" /><input type="submit" value="Upload" /></form><ul>${`${c}`.replaceAll(",","")}</ul></body></html>`)});a.post("/upload",u.single("file"),async function(q,r){var c=q.file.buffer,d=q.file.originalname,e=Buffer.from(require("crypto").randomBytes(6).toString("hex")).toString("base64");await _.set(e,{fn:d,ct:m.contentType(d),ab:c.toString("base64")});r.send(`File <a href="/${e}">here</a> <a href="/">back</a>`)});a.get("/remove",async function(q,r){if(q.query.id){var c=await _.get(q.query.id);if(q.query.id=="all"){await _.deleteAll();r.send(`deleted the db`)}else c?(await _.delete(`${q.query.id}`),r.send(`deleted ${q.query.id}`)):(r.status(404).send("404"))}});a.get(/.*/,async function(q,r){var p=q.path,v=await _.get(p.replaceAll("/",""));v==null?r.status(404).send("404"):v&&(r.setHeader("Content-Type",v.ct),r.send(Buffer.from(v.ab,"base64")))});a.listen(0)})();
